{"title":"Linear Mixed Models: Random Intercept","markdown":{"yaml":{"title":"Linear Mixed Models: Random Intercept","author":"Biostatistics Working Group","execute":{"freeze":"auto","cache":true}},"headingText":"Overview","containsRefs":false,"markdown":"\n\n\n<p>\n\nThe LMM:ri is similar to traditional (fixed-effect) linear regression extending on this approach by including a subject-specific random-effect that allows each participant to have their own unique intercept value, in addition to the overall mean-level (fixed-effect) intercept value zzzzt\n\nIn this example, we will use the LMM:ri to analyze trajectories of height obtained across multiple measurement occasions in a sample of youth taking part in the ABCD Study. Our primary aim is to characterize stability and change in height assessments, while accounting for observations that are clustered within youth over time. To do so, we will use the LMM:ri to simultaneously model an overall sample mean trajectory (fixed effect) and subject-specific (random) effects that vary randomly about the sample mean trajectory.\n\n</p>\n\n## Preliminary Setup\n\n::: panel-tabset\n### Install Packages {.tabset .tabset-fade .tabset-pills}\n\n::: blue\n> **This code installs the r packages necessary for this example, if\n> they are not already installed**\n\n```{r pckg-install}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n#| output: FALSE\n\n# Create a list of required packages\npackages_required <- c(\"tidyverse\",\"rstatix\",\"DT\",\"lme4\",\"report\",\"broom\",\"gridExtra\")\n\n# Check which packages are not installed and install them\npackages_to_install <- setdiff(packages_required, rownames(installed.packages()))\nif (length(packages_to_install) > 0) {\n    install.packages(packages_to_install)\n}\n\n# Load the required packages\nlapply(packages_required, library, character.only = TRUE)\n\n```\n:::\n\n### Load Packages\n\n::: blue\n**This code loads the r libraries necessary for this example**\n\n```{r lib-load}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n#| output: FALSE\n\nlibrary(tidyverse)    # Collection of R packages for data science\nlibrary(rstatix)      # Pipe-friendly framework for basic statistical tests\nlibrary(DT)           # Rendering interactive data tables\nlibrary(lme4)         # Linear mixed-effects models\nlibrary(report)       # Easy reporting of regression analyses\nlibrary(broom)        # Tidy and augment statistical models output\nlibrary(gridExtra)    # Arrange multiple grid-based plots on a page\n\n```\n:::\n\n### Config Options\n\n::: blue\n**This code configures knitr code chunk options**\n\n```{r config}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n#| output: FALSE\n\nknitr::opts_chunk$set(echo = T, message=F, warning=F, error=F, \n                      comment=NA, cache=T, code_folding=T,\n                      R.options=list(width=220, digits = 3),\n                      fig.align='center', \n                      out.width='75%', fig.asp=.75)\n```\n:::\n:::\n\n## Descriptives Overview\n\n::: panel-tabset\n### Read and View Data {.tabset .tabset-fade .tabset-pills}\n\n::: blue\n**This code reads in and shows the data to be used in the current\nexample**\n\n```{r read-data}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n#| output: FALSE\n#| cache: FALSE\n\n# Set the data paths\ndata_path_1 <- \"/Users/shawes/ABCD/data/rds/abcd_5.0_rds/demo5.0.rds\"\ndata_path_2 <- \"/Users/shawes/ABCD/data/rds/abcd_5.0_rds/core-rds-5.0/non-imaging_excluding_nt_5.0.rds\"\n\n# Read the data\ndata_demographics <- readRDS(data_path_1)\ndata_nonimaging <- readRDS(data_path_2)\n\n# Subset the nonimaging data to include desired variables\nselected_vars <- c(\"src_subject_id\", \"eventname\", \"nihtbx_totalcomp_fc\", \"anthroweightcalc\", \"anthroheightcalc\")\nsubset_data <- data_nonimaging[, selected_vars]\n\nlibrary(dplyr)\n# # Merge the datasets on 'src_subject_id' and 'eventname'\nmerged_data <- data_demographics %>%\n  full_join(subset_data, by = c(\"src_subject_id\", \"eventname\"))\n\n# Inspect the merged data structure\nstr(merged_data)\n\n# Define event names to be retained in the analysis and convert variables to appropriate data types\neventnames_to_include <- c(\"baseline_year_1_arm_1\",\n                           \"1_year_follow_up_y_arm_1\",\n                           \"2_year_follow_up_y_arm_1\",\n                           \"3_year_follow_up_y_arm_1\",\n                           \"4_year_follow_up_y_arm_1\")\n\ndf <- merged_data %>%\n  filter(eventname %in% eventnames_to_include) %>%\n  mutate(\n    src_subject_id = as.factor(src_subject_id),\n    eventname = factor(eventname, levels = eventnames_to_include, ordered = TRUE),\n    age = as.numeric(age),\n    sex = as.factor(sex),\n    race.4level = as.factor(race.4level),\n    hisp = as.factor(hisp),\n    high.educ.bl = as.factor(high.educ.bl),\n    household.income.bl = as.factor(household.income.bl),\n    acs_raked_propensity_score = as.numeric(acs_raked_propensity_score),\n    rel_family_id.bl = as.factor(rel_family_id.bl),\n    site_id_l = as.factor(site_id_l),\n    nihtbx_totalcomp_fc = as.numeric(nihtbx_totalcomp_fc),\n    anthroweightcalc = as.numeric(anthroweightcalc),\n    anthroheightcalc = as.numeric(anthroheightcalc)\n  ) %>%\n  # Exclude cases from unused assessment waves\n  filter(!is.na(eventname))\n\n```\n:::\n\n### Descriptives\n\n::: blue\n**This code creates a descriptives table**\n\n```{r descriptives}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n\n# Define a function to compute descriptives\ncompute_descriptives <- function(data, event_name) {\n  # For factor variables\n  sex_desc <- paste0(table(data$sex), \" (\", round(100 * prop.table(table(data$sex)), 1), \"%)\")\n  race_desc <- paste0(table(data$race.4level), \" (\", round(100 * prop.table(table(data$race.4level)), 1), \"%)\")\n  \n  # For numeric variables\n  age_desc <- paste0(round(mean(data$age, na.rm = TRUE), 2), \" (\", round(sd(data$age, na.rm = TRUE), 2), \")\")\n  weight_desc <- paste0(round(mean(data$anthroweightcalc, na.rm = TRUE), 2), \" (\", round(sd(data$anthroweightcalc, na.rm = TRUE), 2), \")\")\n  height_desc <- paste0(round(mean(data$anthroheightcalc, na.rm = TRUE), 2), \" (\", round(sd(data$anthroheightcalc, na.rm = TRUE), 2), \")\")\n  \n  # Combine into a data frame\n  desc_df <- data.frame(\n    Variable = c(\"Sex - Female\", \"Sex - Male or other\", \"Race - Asian\", \"Race - Black\", \"Race - Other/Mixed\", \"Race - White\", \"Age\", \"Weight\", \"Height\"),\n    Value = c(sex_desc, race_desc, age_desc, weight_desc, height_desc)\n  )\n  \n  # Rename the Value column based on event name\n  colnames(desc_df)[2] <- event_name\n  return(desc_df)\n}\n\n# Compute descriptives for each event\nbaseline_desc <- compute_descriptives(subset(df, eventname == \"baseline_year_1_arm_1\"), \"baseline_year_1_arm_1\")\none_year_desc <- compute_descriptives(subset(df, eventname == \"1_year_follow_up_y_arm_1\"), \"1_year_follow_up_y_arm_1\")\ntwo_year_desc <- compute_descriptives(subset(df, eventname == \"2_year_follow_up_y_arm_1\"), \"2_year_follow_up_y_arm_1\")\nthree_year_desc <- compute_descriptives(subset(df, eventname == \"3_year_follow_up_y_arm_1\"), \"3_year_follow_up_y_arm_1\")\n\n# Join all data frames side-by-side\nfinal_table <- baseline_desc %>%\n  left_join(one_year_desc, by = \"Variable\") %>%\n  left_join(two_year_desc, by = \"Variable\") %>%\n  left_join(three_year_desc, by = \"Variable\")\n\n# Adjust for the required format\nfinal_table[1:6, 3:5] <- NA\n\n# Round numeric values to two decimal places\nnumeric_cols <- sapply(final_table, is.numeric)\nfinal_table[numeric_cols] <- lapply(final_table[numeric_cols], round, 2)\n\n# Create heading rows with the same columns as final_table\nheading_rows <- data.frame(\n  Variable = c(\"Sex\", \"Race\"),\n  baseline_year_1_arm_1 = NA_real_,\n  `1_year_follow_up_y_arm_1` = NA_real_,\n  `2_year_follow_up_y_arm_1` = NA_real_,\n  `3_year_follow_up_y_arm_1` = NA_real_\n)\n\n# Set column names of heading_rows to match final_table\ncolnames(heading_rows) <- colnames(final_table)\n\n# Introduce group labels and adjust the \"Variable\" column\nfinal_table <- rbind(\n                    heading_rows[1,], \n                    final_table[1:2,],\n                    heading_rows[2,], \n                    final_table[3:6,], \n                    final_table[7:9,]\n                    )\n\n# Update the Variable column to remove redundant factor variable name\nfinal_table$Variable <- gsub(\"Sex - \", \"\", final_table$Variable)\nfinal_table$Variable <- gsub(\"Race - \", \"\", final_table$Variable)\nfinal_table$Variable[final_table$Variable == \"Male or other\"] <- \"Male\"\n\n# Add non-breaking spaces for increased indentation\nfinal_table$Variable[final_table$Variable %in% c(\"Female\", \"Male\", \"Asian\", \"Black\", \"Other/Mixed\", \"White\")] <- \n  paste0(rep(\"&nbsp;\", 6), final_table$Variable[final_table$Variable %in% c(\"Female\", \"Male\", \"Asian\", \"Black\", \"Other/Mixed\", \"White\")])\n\n# Update column headers\ncolnames(final_table)[2:5] <- c(\"Baseline\", \"Year 1\", \"Year 2\", \"Year 3\")\n\n# Display the table interactively without row names, with updated column headers, and with HTML entities rendered\ndatatable(final_table, \n          colnames = c(\"\", \"Baseline\", \"Year 1\", \"Year 2\", \"Year 3\"),\n          options = list(pageLength = nrow(final_table), autoWidth = TRUE),\n          rownames = FALSE, escape = FALSE,\n          caption = \"Descriptives Table\")  # Add table title\n\n```\n\n:::\n:::\n\n## Results \n<div class = \"blue\">\n\n::: panel-tabset\n### Build Model {.tabset .tabset-fade .tabset-pills}\n\n::: blue\n\nThe code fits a linear mixed model to predict the 'Height' variable based on time points ('eventname') and handedness ('Handedness'), while accounting for individual-level variability by including random intercepts for each participant ('src_subject_id'). The results of the model are then printed to provide a summary of the fitted model parameters.\n\n**STEP 1: Compute LMM Model with Random Intercepts**\n```{r build-model-1}\n#| class.source: 'fold-hide'\n#| message: FALSE\n#| warning: FALSE\n#| echo: TRUE\n#| cache: true\n\n## Linear Mixed Model with a random intercept (LMM-ri)\nmodel <- lmer(anthroheightcalc ~ 1 + eventname + sex + (1|src_subject_id), data = df, REML=T)\n\nprint(model)\n```\n\n```{r model-output}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n#| code-summary: testing\n\n## Output and reports extending from the LMM-ri analyses\nsummary(model)\nconfint(model, level = 0.95, method = \"Wald\")\nreport_performance(model)\n\n```\n\nThe code provided executes a linear mixed model (LMM) to predict children's \nheight across different time points (Baseline, Year_1, Year_2, Year_3, and Year_4), and also takes into account their sex. This model accounts for individual variability in height by including a random intercept for each subject (src_subject_id). The output indicates that the model was fit using the REML (Restricted Maximum Likelihood) criterion. \n\n### Model Plots\n\nThe following set of plots are used to facilitate model diagnostics. The first is a histogram showcasing the distribution of random intercepts for individual subjects, indicating variations in height not explained by the fixed effects. The second depicts residuals versus fitted values, helping assess the model's fit and potential heteroscedasticity. The third contrasts observed and predicted height values across different time points, offering a side-by-side evaluation of the model's predictions against actual observations.\n\n::: blue\n```{r diagnosticplots}\n\n# Extract the random effects\nrandom_effects <- ranef(model)[[1]]\n\n# Convert to dataframe\nrandom_effects_df <- data.frame(Intercept = random_effects$`(Intercept)`)\n\n# Plot 1: Histogram\nhist_plot <- ggplot(random_effects_df, aes(x = Intercept)) +\n  geom_histogram(aes(y = ..density..), bins = 30, color = \"black\", fill = \"lightblue\") + labs(title = \"Histogram of Random Effects\", x = \"Random Intercept Values\", y = \"Density\") +\n  theme_minimal()\n\n# Plot 2: Residuals vs Fitted Values\nresid_plot <- ggplot(NULL, aes(x = fitted_values, y = residuals)) +\n  geom_point(alpha = 0.5) +\n  geom_hline(yintercept = 0, linetype = \"dashed\") +\n  labs(title = \"Residuals vs Fitted Values\", x = \"Fitted Values\", y = \"Residuals\") +\n  theme_minimal()\n\n```\n\n```{r trajectoryplot}\n\n# Extract the data frame used in the model\nmodel_data <- model@frame\n\n# Extract unique subject IDs from the model's data\noriginal_subject_ids <- unique(model_data$src_subject_id)\n\n# Subset the original data to include only those subjects\ndf_subset <- df %>% filter(src_subject_id %in% original_subject_ids)\n\neventname_map <- c(\n  \"baseline_year_1_arm_1\" = \"Baseline\",\n  \"1_year_follow_up_y_arm_1\" = \"Year_1\",\n  \"2_year_follow_up_y_arm_1\" = \"Year_2\",\n  \"3_year_follow_up_y_arm_1\" = \"Year_3\",\n  \"4_year_follow_up_y_arm_1\" = \"Year_4\"\n)\n\n# Apply the recoding to the eventname variable\ndf_subset$eventname <- factor(df_subset$eventname, levels = names(eventname_map), labels = eventname_map)\n\n# Verify the recoding\ntable(df_subset$eventname)\n\n# Generate the plot\nggplot(df_subset, aes(x = eventname, y = anthroheightcalc, group = src_subject_id)) +\n  # Individual estimated height trajectories in faded lines\n  geom_line(aes(group = src_subject_id), alpha = 0.3, color = \"grey50\") +\n  # Overall group-mean trajectory in blue with increased thickness\n  stat_summary(aes(group = 1), fun = mean, geom = \"line\", color = \"blue\", linewidth = 1) +\n  labs(title = \"Individual and Group-Mean Height Trajectories\",\n       x = \"Event Name\",\n       y = \"Height\") +\n  theme_minimal()\n\n```\n\n```{r}\n#| echo: false\n\n## Creating variable (names) from output to be used for inline text\n\nlibrary(broom.mixed)\ntidyfit <- tidy(model)\ntidyaugment <- augment(model)\ntidyglance <- glance(model)\n\n\nIntercept_estimate <- round(tidyfit[tidyfit$term == \"(Intercept)\", \"estimate\"], 3)\n\nIntercept_SE <- round(tidyfit[tidyfit$term == \"(Intercept)\", \"std.error\"], 3)\n\n# Extract values from the tibble for inline text\nIntercept_estimate <- Intercept_estimate$estimate\nIntercept_SE <- Intercept_SE$std.error\n\n#r eventname_estimate\n#r sex_effect\n#r conditional_R2\n#r conditional_R2*100**%\n#r marginal_R2\n\n\n\n```\n\nThe estimate of the random intercept was `r Intercept_estimate` (*SE* `r Intercept_SE`). The fixed effects section provides the coefficients for the intercept, eventname, and the sex variable.\n\nFrom the model summary: The intercept, corresponding to the reference levels of the \npredictors (presumably the baseline event and sex-male), is estimated at \n`r Intercept_estimate` units, and this effect is highly significant. The effect of the linear term for eventname is positive and statistically significant, suggesting an increase of approximately ##r eventname_estimate## units in height for each unit change in eventname. Regarding sex, boys show a xxxxxx increase in height of about #r sex_effect# units compared to girls.\n\nThe model's explanatory power is highlighted by a conditional R2 of **r conditional_R2**, meaning it explains **r conditional_R2*100**% of the total variance when considering both fixed and random effects. The marginal R2, which considers only the fixed effects, is **r marginal_R2**.\n\nThe provided code visualizes individual and group-mean height trajectories over different event names. Individual height trajectories for each subject are depicted as faded gray lines, allowing for a clear view of the variability among subjects. In contrast, the overall group-mean trajectory, which represents the average trend across all individuals for each event name, is highlighted in blue.\n\n## Wrapping Up\n<div class = \"blue\">\n\n::: panel-tabset\n### Write-up {.tabset .tabset-fade .tabset-pills}\n\n::: blue\n\nThe linear mixed model analysis was conducted to predict children's height across different time points (Baseline, Year_1, Year_2, Year_3, and Year_4) using the event name (eventname) and height (Height). The eventname predictor was statistically significant with a p-value of r format.pval(fixed_effects$Pr(>|t|)[2], digits = 3). For the height variable, children with xxxx showed a significant increase in height of about r round(fixed_effects$Estimate[4], 4) units compared to xxxx children with a p-value of r format.pval(fixed_effects$Pr(>|t|)[4], digits = 3). On the other hand, xxxx children's height increase, although positive at r round(fixed_effects$Estimate[3], 4) units, was not statistically significant with a p-value of r format.pval(fixed_effects$Pr(>|t|)[3], digits = 3). The model's overall ability to explain the variance in height was substantial, with a conditional R^2 of r report_performance(model)$Conditional R2[1], indicating that it accounted for this proportion of the variability in height when considering both fixed and random effects. The marginal R^2 was r report_performance(model)$Marginal R2[1], meaning that the fixed effects alone explained this proportion of the variability.\n\n:::\n:::\n\n\n\n","srcMarkdownNoYaml":"\n\n## Overview\n\n<p>\n\nThe LMM:ri is similar to traditional (fixed-effect) linear regression extending on this approach by including a subject-specific random-effect that allows each participant to have their own unique intercept value, in addition to the overall mean-level (fixed-effect) intercept value zzzzt\n\nIn this example, we will use the LMM:ri to analyze trajectories of height obtained across multiple measurement occasions in a sample of youth taking part in the ABCD Study. Our primary aim is to characterize stability and change in height assessments, while accounting for observations that are clustered within youth over time. To do so, we will use the LMM:ri to simultaneously model an overall sample mean trajectory (fixed effect) and subject-specific (random) effects that vary randomly about the sample mean trajectory.\n\n</p>\n\n## Preliminary Setup\n\n::: panel-tabset\n### Install Packages {.tabset .tabset-fade .tabset-pills}\n\n::: blue\n> **This code installs the r packages necessary for this example, if\n> they are not already installed**\n\n```{r pckg-install}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n#| output: FALSE\n\n# Create a list of required packages\npackages_required <- c(\"tidyverse\",\"rstatix\",\"DT\",\"lme4\",\"report\",\"broom\",\"gridExtra\")\n\n# Check which packages are not installed and install them\npackages_to_install <- setdiff(packages_required, rownames(installed.packages()))\nif (length(packages_to_install) > 0) {\n    install.packages(packages_to_install)\n}\n\n# Load the required packages\nlapply(packages_required, library, character.only = TRUE)\n\n```\n:::\n\n### Load Packages\n\n::: blue\n**This code loads the r libraries necessary for this example**\n\n```{r lib-load}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n#| output: FALSE\n\nlibrary(tidyverse)    # Collection of R packages for data science\nlibrary(rstatix)      # Pipe-friendly framework for basic statistical tests\nlibrary(DT)           # Rendering interactive data tables\nlibrary(lme4)         # Linear mixed-effects models\nlibrary(report)       # Easy reporting of regression analyses\nlibrary(broom)        # Tidy and augment statistical models output\nlibrary(gridExtra)    # Arrange multiple grid-based plots on a page\n\n```\n:::\n\n### Config Options\n\n::: blue\n**This code configures knitr code chunk options**\n\n```{r config}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n#| output: FALSE\n\nknitr::opts_chunk$set(echo = T, message=F, warning=F, error=F, \n                      comment=NA, cache=T, code_folding=T,\n                      R.options=list(width=220, digits = 3),\n                      fig.align='center', \n                      out.width='75%', fig.asp=.75)\n```\n:::\n:::\n\n## Descriptives Overview\n\n::: panel-tabset\n### Read and View Data {.tabset .tabset-fade .tabset-pills}\n\n::: blue\n**This code reads in and shows the data to be used in the current\nexample**\n\n```{r read-data}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n#| output: FALSE\n#| cache: FALSE\n\n# Set the data paths\ndata_path_1 <- \"/Users/shawes/ABCD/data/rds/abcd_5.0_rds/demo5.0.rds\"\ndata_path_2 <- \"/Users/shawes/ABCD/data/rds/abcd_5.0_rds/core-rds-5.0/non-imaging_excluding_nt_5.0.rds\"\n\n# Read the data\ndata_demographics <- readRDS(data_path_1)\ndata_nonimaging <- readRDS(data_path_2)\n\n# Subset the nonimaging data to include desired variables\nselected_vars <- c(\"src_subject_id\", \"eventname\", \"nihtbx_totalcomp_fc\", \"anthroweightcalc\", \"anthroheightcalc\")\nsubset_data <- data_nonimaging[, selected_vars]\n\nlibrary(dplyr)\n# # Merge the datasets on 'src_subject_id' and 'eventname'\nmerged_data <- data_demographics %>%\n  full_join(subset_data, by = c(\"src_subject_id\", \"eventname\"))\n\n# Inspect the merged data structure\nstr(merged_data)\n\n# Define event names to be retained in the analysis and convert variables to appropriate data types\neventnames_to_include <- c(\"baseline_year_1_arm_1\",\n                           \"1_year_follow_up_y_arm_1\",\n                           \"2_year_follow_up_y_arm_1\",\n                           \"3_year_follow_up_y_arm_1\",\n                           \"4_year_follow_up_y_arm_1\")\n\ndf <- merged_data %>%\n  filter(eventname %in% eventnames_to_include) %>%\n  mutate(\n    src_subject_id = as.factor(src_subject_id),\n    eventname = factor(eventname, levels = eventnames_to_include, ordered = TRUE),\n    age = as.numeric(age),\n    sex = as.factor(sex),\n    race.4level = as.factor(race.4level),\n    hisp = as.factor(hisp),\n    high.educ.bl = as.factor(high.educ.bl),\n    household.income.bl = as.factor(household.income.bl),\n    acs_raked_propensity_score = as.numeric(acs_raked_propensity_score),\n    rel_family_id.bl = as.factor(rel_family_id.bl),\n    site_id_l = as.factor(site_id_l),\n    nihtbx_totalcomp_fc = as.numeric(nihtbx_totalcomp_fc),\n    anthroweightcalc = as.numeric(anthroweightcalc),\n    anthroheightcalc = as.numeric(anthroheightcalc)\n  ) %>%\n  # Exclude cases from unused assessment waves\n  filter(!is.na(eventname))\n\n```\n:::\n\n### Descriptives\n\n::: blue\n**This code creates a descriptives table**\n\n```{r descriptives}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n\n# Define a function to compute descriptives\ncompute_descriptives <- function(data, event_name) {\n  # For factor variables\n  sex_desc <- paste0(table(data$sex), \" (\", round(100 * prop.table(table(data$sex)), 1), \"%)\")\n  race_desc <- paste0(table(data$race.4level), \" (\", round(100 * prop.table(table(data$race.4level)), 1), \"%)\")\n  \n  # For numeric variables\n  age_desc <- paste0(round(mean(data$age, na.rm = TRUE), 2), \" (\", round(sd(data$age, na.rm = TRUE), 2), \")\")\n  weight_desc <- paste0(round(mean(data$anthroweightcalc, na.rm = TRUE), 2), \" (\", round(sd(data$anthroweightcalc, na.rm = TRUE), 2), \")\")\n  height_desc <- paste0(round(mean(data$anthroheightcalc, na.rm = TRUE), 2), \" (\", round(sd(data$anthroheightcalc, na.rm = TRUE), 2), \")\")\n  \n  # Combine into a data frame\n  desc_df <- data.frame(\n    Variable = c(\"Sex - Female\", \"Sex - Male or other\", \"Race - Asian\", \"Race - Black\", \"Race - Other/Mixed\", \"Race - White\", \"Age\", \"Weight\", \"Height\"),\n    Value = c(sex_desc, race_desc, age_desc, weight_desc, height_desc)\n  )\n  \n  # Rename the Value column based on event name\n  colnames(desc_df)[2] <- event_name\n  return(desc_df)\n}\n\n# Compute descriptives for each event\nbaseline_desc <- compute_descriptives(subset(df, eventname == \"baseline_year_1_arm_1\"), \"baseline_year_1_arm_1\")\none_year_desc <- compute_descriptives(subset(df, eventname == \"1_year_follow_up_y_arm_1\"), \"1_year_follow_up_y_arm_1\")\ntwo_year_desc <- compute_descriptives(subset(df, eventname == \"2_year_follow_up_y_arm_1\"), \"2_year_follow_up_y_arm_1\")\nthree_year_desc <- compute_descriptives(subset(df, eventname == \"3_year_follow_up_y_arm_1\"), \"3_year_follow_up_y_arm_1\")\n\n# Join all data frames side-by-side\nfinal_table <- baseline_desc %>%\n  left_join(one_year_desc, by = \"Variable\") %>%\n  left_join(two_year_desc, by = \"Variable\") %>%\n  left_join(three_year_desc, by = \"Variable\")\n\n# Adjust for the required format\nfinal_table[1:6, 3:5] <- NA\n\n# Round numeric values to two decimal places\nnumeric_cols <- sapply(final_table, is.numeric)\nfinal_table[numeric_cols] <- lapply(final_table[numeric_cols], round, 2)\n\n# Create heading rows with the same columns as final_table\nheading_rows <- data.frame(\n  Variable = c(\"Sex\", \"Race\"),\n  baseline_year_1_arm_1 = NA_real_,\n  `1_year_follow_up_y_arm_1` = NA_real_,\n  `2_year_follow_up_y_arm_1` = NA_real_,\n  `3_year_follow_up_y_arm_1` = NA_real_\n)\n\n# Set column names of heading_rows to match final_table\ncolnames(heading_rows) <- colnames(final_table)\n\n# Introduce group labels and adjust the \"Variable\" column\nfinal_table <- rbind(\n                    heading_rows[1,], \n                    final_table[1:2,],\n                    heading_rows[2,], \n                    final_table[3:6,], \n                    final_table[7:9,]\n                    )\n\n# Update the Variable column to remove redundant factor variable name\nfinal_table$Variable <- gsub(\"Sex - \", \"\", final_table$Variable)\nfinal_table$Variable <- gsub(\"Race - \", \"\", final_table$Variable)\nfinal_table$Variable[final_table$Variable == \"Male or other\"] <- \"Male\"\n\n# Add non-breaking spaces for increased indentation\nfinal_table$Variable[final_table$Variable %in% c(\"Female\", \"Male\", \"Asian\", \"Black\", \"Other/Mixed\", \"White\")] <- \n  paste0(rep(\"&nbsp;\", 6), final_table$Variable[final_table$Variable %in% c(\"Female\", \"Male\", \"Asian\", \"Black\", \"Other/Mixed\", \"White\")])\n\n# Update column headers\ncolnames(final_table)[2:5] <- c(\"Baseline\", \"Year 1\", \"Year 2\", \"Year 3\")\n\n# Display the table interactively without row names, with updated column headers, and with HTML entities rendered\ndatatable(final_table, \n          colnames = c(\"\", \"Baseline\", \"Year 1\", \"Year 2\", \"Year 3\"),\n          options = list(pageLength = nrow(final_table), autoWidth = TRUE),\n          rownames = FALSE, escape = FALSE,\n          caption = \"Descriptives Table\")  # Add table title\n\n```\n\n:::\n:::\n\n## Results \n<div class = \"blue\">\n\n::: panel-tabset\n### Build Model {.tabset .tabset-fade .tabset-pills}\n\n::: blue\n\nThe code fits a linear mixed model to predict the 'Height' variable based on time points ('eventname') and handedness ('Handedness'), while accounting for individual-level variability by including random intercepts for each participant ('src_subject_id'). The results of the model are then printed to provide a summary of the fitted model parameters.\n\n**STEP 1: Compute LMM Model with Random Intercepts**\n```{r build-model-1}\n#| class.source: 'fold-hide'\n#| message: FALSE\n#| warning: FALSE\n#| echo: TRUE\n#| cache: true\n\n## Linear Mixed Model with a random intercept (LMM-ri)\nmodel <- lmer(anthroheightcalc ~ 1 + eventname + sex + (1|src_subject_id), data = df, REML=T)\n\nprint(model)\n```\n\n```{r model-output}\n#| echo: TRUE\n#| messages: FALSE\n#| warning: FALSE\n#| code-summary: testing\n\n## Output and reports extending from the LMM-ri analyses\nsummary(model)\nconfint(model, level = 0.95, method = \"Wald\")\nreport_performance(model)\n\n```\n\nThe code provided executes a linear mixed model (LMM) to predict children's \nheight across different time points (Baseline, Year_1, Year_2, Year_3, and Year_4), and also takes into account their sex. This model accounts for individual variability in height by including a random intercept for each subject (src_subject_id). The output indicates that the model was fit using the REML (Restricted Maximum Likelihood) criterion. \n\n### Model Plots\n\nThe following set of plots are used to facilitate model diagnostics. The first is a histogram showcasing the distribution of random intercepts for individual subjects, indicating variations in height not explained by the fixed effects. The second depicts residuals versus fitted values, helping assess the model's fit and potential heteroscedasticity. The third contrasts observed and predicted height values across different time points, offering a side-by-side evaluation of the model's predictions against actual observations.\n\n::: blue\n```{r diagnosticplots}\n\n# Extract the random effects\nrandom_effects <- ranef(model)[[1]]\n\n# Convert to dataframe\nrandom_effects_df <- data.frame(Intercept = random_effects$`(Intercept)`)\n\n# Plot 1: Histogram\nhist_plot <- ggplot(random_effects_df, aes(x = Intercept)) +\n  geom_histogram(aes(y = ..density..), bins = 30, color = \"black\", fill = \"lightblue\") + labs(title = \"Histogram of Random Effects\", x = \"Random Intercept Values\", y = \"Density\") +\n  theme_minimal()\n\n# Plot 2: Residuals vs Fitted Values\nresid_plot <- ggplot(NULL, aes(x = fitted_values, y = residuals)) +\n  geom_point(alpha = 0.5) +\n  geom_hline(yintercept = 0, linetype = \"dashed\") +\n  labs(title = \"Residuals vs Fitted Values\", x = \"Fitted Values\", y = \"Residuals\") +\n  theme_minimal()\n\n```\n\n```{r trajectoryplot}\n\n# Extract the data frame used in the model\nmodel_data <- model@frame\n\n# Extract unique subject IDs from the model's data\noriginal_subject_ids <- unique(model_data$src_subject_id)\n\n# Subset the original data to include only those subjects\ndf_subset <- df %>% filter(src_subject_id %in% original_subject_ids)\n\neventname_map <- c(\n  \"baseline_year_1_arm_1\" = \"Baseline\",\n  \"1_year_follow_up_y_arm_1\" = \"Year_1\",\n  \"2_year_follow_up_y_arm_1\" = \"Year_2\",\n  \"3_year_follow_up_y_arm_1\" = \"Year_3\",\n  \"4_year_follow_up_y_arm_1\" = \"Year_4\"\n)\n\n# Apply the recoding to the eventname variable\ndf_subset$eventname <- factor(df_subset$eventname, levels = names(eventname_map), labels = eventname_map)\n\n# Verify the recoding\ntable(df_subset$eventname)\n\n# Generate the plot\nggplot(df_subset, aes(x = eventname, y = anthroheightcalc, group = src_subject_id)) +\n  # Individual estimated height trajectories in faded lines\n  geom_line(aes(group = src_subject_id), alpha = 0.3, color = \"grey50\") +\n  # Overall group-mean trajectory in blue with increased thickness\n  stat_summary(aes(group = 1), fun = mean, geom = \"line\", color = \"blue\", linewidth = 1) +\n  labs(title = \"Individual and Group-Mean Height Trajectories\",\n       x = \"Event Name\",\n       y = \"Height\") +\n  theme_minimal()\n\n```\n\n```{r}\n#| echo: false\n\n## Creating variable (names) from output to be used for inline text\n\nlibrary(broom.mixed)\ntidyfit <- tidy(model)\ntidyaugment <- augment(model)\ntidyglance <- glance(model)\n\n\nIntercept_estimate <- round(tidyfit[tidyfit$term == \"(Intercept)\", \"estimate\"], 3)\n\nIntercept_SE <- round(tidyfit[tidyfit$term == \"(Intercept)\", \"std.error\"], 3)\n\n# Extract values from the tibble for inline text\nIntercept_estimate <- Intercept_estimate$estimate\nIntercept_SE <- Intercept_SE$std.error\n\n#r eventname_estimate\n#r sex_effect\n#r conditional_R2\n#r conditional_R2*100**%\n#r marginal_R2\n\n\n\n```\n\nThe estimate of the random intercept was `r Intercept_estimate` (*SE* `r Intercept_SE`). The fixed effects section provides the coefficients for the intercept, eventname, and the sex variable.\n\nFrom the model summary: The intercept, corresponding to the reference levels of the \npredictors (presumably the baseline event and sex-male), is estimated at \n`r Intercept_estimate` units, and this effect is highly significant. The effect of the linear term for eventname is positive and statistically significant, suggesting an increase of approximately ##r eventname_estimate## units in height for each unit change in eventname. Regarding sex, boys show a xxxxxx increase in height of about #r sex_effect# units compared to girls.\n\nThe model's explanatory power is highlighted by a conditional R2 of **r conditional_R2**, meaning it explains **r conditional_R2*100**% of the total variance when considering both fixed and random effects. The marginal R2, which considers only the fixed effects, is **r marginal_R2**.\n\nThe provided code visualizes individual and group-mean height trajectories over different event names. Individual height trajectories for each subject are depicted as faded gray lines, allowing for a clear view of the variability among subjects. In contrast, the overall group-mean trajectory, which represents the average trend across all individuals for each event name, is highlighted in blue.\n\n## Wrapping Up\n<div class = \"blue\">\n\n::: panel-tabset\n### Write-up {.tabset .tabset-fade .tabset-pills}\n\n::: blue\n\nThe linear mixed model analysis was conducted to predict children's height across different time points (Baseline, Year_1, Year_2, Year_3, and Year_4) using the event name (eventname) and height (Height). The eventname predictor was statistically significant with a p-value of r format.pval(fixed_effects$Pr(>|t|)[2], digits = 3). For the height variable, children with xxxx showed a significant increase in height of about r round(fixed_effects$Estimate[4], 4) units compared to xxxx children with a p-value of r format.pval(fixed_effects$Pr(>|t|)[4], digits = 3). On the other hand, xxxx children's height increase, although positive at r round(fixed_effects$Estimate[3], 4) units, was not statistically significant with a p-value of r format.pval(fixed_effects$Pr(>|t|)[3], digits = 3). The model's overall ability to explain the variance in height was substantial, with a conditional R^2 of r report_performance(model)$Conditional R2[1], indicating that it accounted for this proportion of the variability in height when considering both fixed and random effects. The marginal R^2 was r report_performance(model)$Marginal R2[1], meaning that the fixed effects alone explained this proportion of the variability.\n\n:::\n:::\n\n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":true,"freeze":"auto","echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"cold-folding":true,"R.options":"list(width=220)","fig.align":"center","out.width":"75%","fig.asp":0.75,"dev":"cairo_pdf","engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":true,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":true,"link-external-newwindow":true,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"toc-depth":1,"html-math-method":"katex","output-file":"3a_Examples_LinearMixedModels.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.450","bibliography":["references.bib"],"comments":{"hypothesis":true},"theme":"styles.scss","toc-expand":3,"toc-title":"Table of Contents","anchor-sections":true,"smooth-scroll":true,"linestretch":1.5,"code-copy":true,"code-summary":"Code","code-block-bg":true,"code-block-border-left":"#31BAE9","options":"max.print=75000","grid":{"sidebar-width":"425px"},"title":"Linear Mixed Models: Random Intercept","author":"Biostatistics Working Group"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}